<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Translator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .listening-indicator {
      width: 20px;
      height: 20px;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse 1s infinite;
    }
  </style>
</head>
<body class="gradient-bg min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-white mb-2">🎤 Voice Translator</h1>
      <p class="text-white/80 text-lg">Speak in any language, get instant translations</p>
    </div>

    <!-- Main Card -->
    <div class="glass-effect rounded-2xl p-8 shadow-2xl">
      <!-- Language Selection -->
      <div class="grid md:grid-cols-2 gap-6 mb-8">
        <div>
          <label for="srcLang" class="block text-white font-medium mb-3 text-sm uppercase tracking-wide">
            🗣️ Source Language
          </label>
          <select id="srcLang" class="w-full p-4 rounded-xl bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent backdrop-blur-sm">
            <option value="auto" class="text-gray-800">🌐 Auto Detect</option>
            <option value="en-US" class="text-gray-800">🇺🇸 English</option>
            <option value="fa-IR" class="text-gray-800">🇮🇷 Persian</option>
            <option value="es-ES" class="text-gray-800">🇪🇸 Spanish</option>
            <option value="fr-FR" class="text-gray-800">🇫🇷 French</option>
            <option value="de-DE" class="text-gray-800">🇩🇪 German</option>
            <option value="it-IT" class="text-gray-800">🇮🇹 Italian</option>
            <option value="ja-JP" class="text-gray-800">🇯🇵 Japanese</option>
            <option value="ko-KR" class="text-gray-800">🇰🇷 Korean</option>
            <option value="zh-CN" class="text-gray-800">🇨🇳 Chinese (Simplified)</option>
            <option value="ru-RU" class="text-gray-800">🇷🇺 Russian</option>
            <option value="ar-SA" class="text-gray-800">🇸🇦 Arabic</option>
            <option value="pt-PT" class="text-gray-800">🇵🇹 Portuguese</option>
            <option value="hi-IN" class="text-gray-800">🇮🇳 Hindi</option>
            <option value="bn-BD" class="text-gray-800">🇧🇩 Bengali</option>
            <option value="tr-TR" class="text-gray-800">🇹🇷 Turkish</option>
            <option value="th-TH" class="text-gray-800">🇹🇭 Thai</option>
            <option value="vi-VN" class="text-gray-800">🇻🇳 Vietnamese</option>
            <option value="nl-NL" class="text-gray-800">🇳🇱 Dutch</option>
            <option value="sv-SE" class="text-gray-800">🇸🇪 Swedish</option>
          </select>
        </div>

        <div>
          <label for="tgtLang" class="block text-white font-medium mb-3 text-sm uppercase tracking-wide">
            🎯 Target Language
          </label>
          <select id="tgtLang" class="w-full p-4 rounded-xl bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent backdrop-blur-sm">
            <option value="en" class="text-gray-800">🇺🇸 English</option>
            <option value="fa" class="text-gray-800">🇮🇷 Persian</option>
            <option value="es" class="text-gray-800">🇪🇸 Spanish</option>
            <option value="fr" class="text-gray-800">🇫🇷 French</option>
            <option value="de" class="text-gray-800">🇩🇪 German</option>
            <option value="it" class="text-gray-800">🇮🇹 Italian</option>
            <option value="ja" class="text-gray-800">🇯🇵 Japanese</option>
            <option value="ko" class="text-gray-800">🇰🇷 Korean</option>
            <option value="zh" class="text-gray-800">🇨🇳 Chinese (Simplified)</option>
            <option value="ru" class="text-gray-800">🇷🇺 Russian</option>
            <option value="ar" class="text-gray-800">🇸🇦 Arabic</option>
            <option value="pt" class="text-gray-800">🇵🇹 Portuguese</option>
            <option value="hi" class="text-gray-800">🇮🇳 Hindi</option>
            <option value="bn" class="text-gray-800">🇧🇩 Bengali</option>
            <option value="tr" class="text-gray-800">🇹🇷 Turkish</option>
            <option value="th" class="text-gray-800">🇹🇭 Thai</option>
            <option value="vi" class="text-gray-800">🇻🇳 Vietnamese</option>
            <option value="nl" class="text-gray-800">🇳🇱 Dutch</option>
            <option value="sv" class="text-gray-800">🇸🇪 Swedish</option>
          </select>
        </div>
      </div>

      <!-- Text Import Section -->
      <div class="mb-8 p-6 rounded-xl bg-white/5 border border-white/10">
        <label for="textInput" class="block text-white font-medium mb-3 text-sm uppercase tracking-wide">
          📝 Import Text for Translation
        </label>
        <div class="flex gap-4">
          <textarea 
            id="textInput" 
            placeholder="Type or paste text here to translate..."
            class="flex-1 p-4 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent backdrop-blur-sm resize-none h-24"
          ></textarea>
          <button id="translateBtn" class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg h-fit">
            <span class="text-xl">🔄</span>
            Translate Text
          </button>
        </div>
      </div>

      <!-- Control Buttons -->
      <div class="flex flex-wrap gap-4 justify-center mb-8">
        <button id="startBtn" class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg">
          <span class="text-xl">▶️</span>
          Start Listening
        </button>
        <button id="pauseBtn" class="flex items-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg" disabled>
          <span class="text-xl">⏸️</span>
          Pause
        </button>
        <button id="stopBtn" class="flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg" disabled>
          <span class="text-xl">⏹️</span>
          Stop
        </button>
        <button id="speakBtn" class="flex items-center gap-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg" disabled>
          <span class="text-xl">🔊</span>
          Speak Translation
        </button>
        <button id="clearBtn" class="flex items-center gap-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg">
          <span class="text-xl">🗑️</span>
          Clear
        </button>
      </div>

      <!-- Auto-speak Toggle -->
      <div class="flex items-center justify-center gap-3 mb-6 p-4 rounded-xl bg-white/5">
        <label class="flex items-center gap-2 text-white cursor-pointer">
          <input type="checkbox" id="autoSpeak" class="w-4 h-4 text-purple-600 bg-white/20 border-white/30 rounded focus:ring-purple-500 focus:ring-2">
          <span class="text-sm font-medium">🔊 Auto-speak translations</span>
        </label>
      </div>

      <!-- Status Indicator -->
      <div id="statusIndicator" class="flex items-center justify-center gap-3 mb-6 p-4 rounded-xl bg-white/5">
        <div id="listeningDot" class="w-3 h-3 bg-gray-400 rounded-full"></div>
        <span id="statusText" class="text-white font-medium">Ready to listen</span>
      </div>

      <!-- Output Area -->
      <div class="space-y-4">
        <label class="block text-white font-medium text-sm uppercase tracking-wide">
          📝 Translation Results
        </label>
        <textarea 
          id="output" 
          readonly 
          placeholder="Your recognized speech and translations will appear here..."
          class="w-full h-64 p-4 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent backdrop-blur-sm resize-none font-mono text-sm leading-relaxed"
        ></textarea>
      </div>

      <!-- Info Notice -->
      <div class="mt-6 p-4 bg-green-500/20 border border-green-400/30 rounded-xl">
        <div class="flex items-center gap-2 text-green-200">
          <span class="text-xl">✅</span>
          <span class="font-semibold">Fully Functional</span>
        </div>
        <p class="text-green-100 text-sm mt-1">
          Speech recognition and real-time translation are both working! Uses free translation APIs for accurate results.
        </p>
      </div>
    </div>
  </div>

  <script>
    let recognition;
    let recognizing = false;
    let paused = false;
    let lastTranslation = '';
    let speechSynthesis = window.speechSynthesis;

    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const stopBtn = document.getElementById("stopBtn");
    const speakBtn = document.getElementById("speakBtn");
    const clearBtn = document.getElementById("clearBtn");
    const translateBtn = document.getElementById("translateBtn");
    const autoSpeak = document.getElementById("autoSpeak");
    const output = document.getElementById("output");
    const textInput = document.getElementById("textInput");
    const srcLang = document.getElementById("srcLang");
    const tgtLang = document.getElementById("tgtLang");
    const statusText = document.getElementById("statusText");
    const listeningDot = document.getElementById("listeningDot");

    // Update button states
    function updateButtonStates() {
      startBtn.disabled = recognizing && !paused;
      pauseBtn.disabled = !recognizing || paused;
      stopBtn.disabled = !recognizing;
      speakBtn.disabled = !lastTranslation || speechSynthesis.speaking;
      
      // Update button opacity based on disabled state
      [startBtn, pauseBtn, stopBtn, speakBtn].forEach(btn => {
        btn.style.opacity = btn.disabled ? '0.5' : '1';
        btn.style.cursor = btn.disabled ? 'not-allowed' : 'pointer';
      });
    }

    // Update status indicator
    function updateStatus(status, isListening = false) {
      statusText.textContent = status;
      if (isListening) {
        listeningDot.className = "listening-indicator";
      } else {
        listeningDot.className = "w-3 h-3 bg-gray-400 rounded-full";
      }
    }

    // Add timestamp to output
    function addToOutput(text, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'recognized' ? '🎤' : type === 'translated' ? '🌐' : 'ℹ️';
      output.value += `\n[${timestamp}] ${prefix} ${text}`;
      output.scrollTop = output.scrollHeight;
    }

    // Text-to-speech function
    function speakText(text, lang) {
      if (!speechSynthesis) {
        addToOutput("Text-to-speech not supported in this browser", 'error');
        return;
      }

      // Stop any ongoing speech
      speechSynthesis.cancel();

      const utterance = new SpeechSynthesisUtterance(text);
      
      // Map language codes to speech synthesis languages
      const langMap = {
        'en': 'en-US', 'fa': 'fa-IR', 'es': 'es-ES', 'fr': 'fr-FR',
        'de': 'de-DE', 'it': 'it-IT', 'ja': 'ja-JP', 'ko': 'ko-KR',
        'zh': 'zh-CN', 'ru': 'ru-RU', 'ar': 'ar-SA', 'pt': 'pt-PT',
        'hi': 'hi-IN', 'bn': 'bn-BD', 'tr': 'tr-TR', 'th': 'th-TH',
        'vi': 'vi-VN', 'nl': 'nl-NL', 'sv': 'sv-SE'
      };

      utterance.lang = langMap[lang] || lang;
      
      // Special settings for Persian to improve pronunciation
      if (lang === 'fa') {
        utterance.rate = 0.8; // Slower for better Persian pronunciation
        utterance.pitch = 1.1; // Slightly higher pitch for Persian
        
        // Try to find Persian voice
        const voices = speechSynthesis.getVoices();
        const persianVoice = voices.find(voice => 
          voice.lang.includes('fa') || 
          voice.lang.includes('persian') || 
          voice.name.toLowerCase().includes('persian') ||
          voice.name.toLowerCase().includes('farsi')
        );
        
        if (persianVoice) {
          utterance.voice = persianVoice;
          addToOutput(`Using Persian voice: ${persianVoice.name}`, 'info');
        } else {
          // Fallback: try Arabic voice for better Persian pronunciation
          const arabicVoice = voices.find(voice => voice.lang.includes('ar'));
          if (arabicVoice) {
            utterance.voice = arabicVoice;
            addToOutput("Using Arabic voice for Persian (closest available)", 'info');
          } else {
            addToOutput("No Persian voice found, using default voice", 'info');
          }
        }
      } else {
        utterance.rate = 0.9;
        utterance.pitch = 1;
      }
      
      utterance.volume = 1;

      utterance.onstart = () => {
        updateStatus("Speaking translation...");
        updateButtonStates();
      };

      utterance.onend = () => {
        updateStatus(recognizing ? "Listening... Speak now!" : "Ready to listen", recognizing);
        updateButtonStates();
      };

      utterance.onerror = (event) => {
        addToOutput(`Speech error: ${event.error}`, 'error');
        updateButtonStates();
      };

      speechSynthesis.speak(utterance);
    }

    // Real translation function using MyMemory API
    async function translateText(text, targetLang) {
      try {
        // Use MyMemory free translation API
        const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=auto|${targetLang}`);
        const data = await response.json();
        
        if (data.responseStatus === 200 && data.responseData) {
          return data.responseData.translatedText;
        } else {
          throw new Error('Translation service unavailable');
        }
      } catch (error) {
        // Fallback to Google Translate API (free tier)
        try {
          const googleResponse = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`);
          const googleData = await googleResponse.json();
          
          if (googleData && googleData[0] && googleData[0][0]) {
            return googleData[0][0][0];
          }
        } catch (googleError) {
          console.error('Translation failed:', googleError);
        }
        
        // If all APIs fail, return original text with note
        return `[Translation unavailable] ${text}`;
      }
    }

    // Initialize speech recognition
    if (!("webkitSpeechRecognition" in window) && !("SpeechRecognition" in window)) {
      addToOutput("Speech recognition is not supported in this browser. Please use Chrome or Edge.", 'error');
      startBtn.disabled = true;
      updateButtonStates();
    } else {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = false;

      recognition.onstart = () => {
        recognizing = true;
        paused = false;
        updateStatus("Listening... Speak now!", true);
        addToOutput("Listening started - speak clearly into your microphone");
        updateButtonStates();
      };

      recognition.onerror = (event) => {
        addToOutput(`Error: ${event.error}`, 'error');
        if (event.error === 'not-allowed') {
          addToOutput("Microphone access denied. Please allow microphone access and try again.", 'error');
        }
      };

      recognition.onend = () => {
        recognizing = false;
        paused = false;
        updateStatus("Ready to listen");
        addToOutput("Listening stopped");
        updateButtonStates();
      };

      recognition.onresult = async (event) => {
        const transcript = event.results[event.results.length - 1][0].transcript.trim();
        addToOutput(`"${transcript}"`, 'recognized');

        // Real translation
        try {
          updateStatus("Translating...");
          const translation = await translateText(transcript, tgtLang.value);
          lastTranslation = translation;
          addToOutput(translation, 'translated');
          updateButtonStates();
          
          // Auto-speak if enabled
          if (autoSpeak.checked) {
            speakText(translation, tgtLang.value);
          } else {
            updateStatus("Listening... Speak now!", true);
          }
        } catch (error) {
          addToOutput(`Translation error: ${error.message}`, 'error');
          updateStatus("Listening... Speak now!", true);
        }
      };
    }

    // Event listeners
    startBtn.addEventListener("click", () => {
      if (recognition) {
        const selectedLang = srcLang.value === 'auto' ? 'en-US' : srcLang.value;
        recognition.lang = selectedLang;
        recognition.start();
      }
    });

    pauseBtn.addEventListener("click", () => {
      if (recognition && recognizing) {
        recognition.stop();
        paused = true;
        updateStatus("Paused - click Start to resume");
        addToOutput("Recognition paused");
        updateButtonStates();
      }
    });

    stopBtn.addEventListener("click", () => {
      if (recognition && recognizing) {
        recognition.stop();
        updateStatus("Stopped");
        addToOutput("Recognition stopped");
      }
    });

    speakBtn.addEventListener("click", () => {
      if (lastTranslation) {
        speakText(lastTranslation, tgtLang.value);
      }
    });

    translateBtn.addEventListener("click", async () => {
      const text = textInput.value.trim();
      if (!text) {
        addToOutput("Please enter some text to translate", 'error');
        return;
      }

      try {
        updateStatus("Translating imported text...");
        addToOutput(`Imported text: "${text}"`, 'recognized');
        
        const translation = await translateText(text, tgtLang.value);
        lastTranslation = translation;
        addToOutput(translation, 'translated');
        updateButtonStates();
        
        // Auto-speak if enabled
        if (autoSpeak.checked) {
          speakText(translation, tgtLang.value);
        } else {
          updateStatus("Translation complete");
        }
        
        // Clear the input after successful translation
        textInput.value = '';
      } catch (error) {
        addToOutput(`Translation error: ${error.message}`, 'error');
        updateStatus("Translation failed");
      }
    });

    // Allow Enter key to trigger translation
    textInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        translateBtn.click();
      }
    });

    clearBtn.addEventListener("click", () => {
      output.value = "";
      textInput.value = "";
      lastTranslation = '';
      speechSynthesis.cancel();
      updateButtonStates();
      addToOutput("Output cleared - ready for new session");
    });

    // Load voices when they become available
    function loadVoices() {
      const voices = speechSynthesis.getVoices();
      const persianVoices = voices.filter(voice => 
        voice.lang.includes('fa') || 
        voice.name.toLowerCase().includes('persian') ||
        voice.name.toLowerCase().includes('farsi')
      );
      
      if (persianVoices.length > 0) {
        addToOutput(`Found ${persianVoices.length} Persian voice(s): ${persianVoices.map(v => v.name).join(', ')}`, 'info');
      } else {
        addToOutput("No Persian voices found. Will use fallback voice for Persian text.", 'info');
      }
    }

    // Load voices on page load and when voices change
    speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices(); // Try to load immediately

    // Initialize button states
    updateButtonStates();
    addToOutput("Voice Translator ready! Select your languages and click Start to begin.");
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96b0f1fb356adf5e',t:'MTc1NDUwODU4OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
